---
title: "temp_excess.rmd"
output: html_document
date: "2025-11-14"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.




Excess code - not submitted for formative:

Join prescription with health board names and filter for only cholesterol-lowering drugs:
```{r}
cholesterol_lowering_prescriptions <- hb_all %>% 
  full_join(health_board_names, join_by(hbt == hb)) %>% 
  #filter for only cholesterol (STATIN) drugs
   filter(str_detect(bnf_item_description, "STATIN")) %>% 
  group_by(bnf_item_description) %>% 
  select(hbt, bnf_item_description, paid_quantity, hb_name)
```

Find all statins used - this is done to obtain a list of all statins without repetition, to more easily visualise:
```{r}
tibble <- cholesterol_lowering_prescriptions %>% 
  distinct(bnf_item_description) %>% 
  arrange(bnf_item_description)
# list of drugs used:
#atorvastatin, fluvastatin, nystatin, pravastatin, rosuvastatin, sandostatin, simvastatin, ecostatin.
```

Making table of all statin drugs grouped:
Drugs were grouped due to the large variation in doses for each drug which make number of prescriptions themselves unclear. We did grouping so that we could visualise and better answer the proposed hypothesis.
```{r}
grouped_cholesterol_lowering_prescriptions <- cholesterol_lowering_prescriptions %>% 
  left_join(population_data, by = c("hb_name" = "hb_name")) %>% 
  mutate(drug_group = str_extract(bnf_item_description, "ATORVASTATIN|FLUVASTATIN|NYSTATIN|PRAVASTATIN|ROSUVASTATIN|SANDOSTATIN|SIMVASTATIN|ECOSTATIN")) %>% 
  mutate(quantity_per_head = sum(paid_quantity)/mean(hb_population)) %>% 
  filter(!is.na(drug_group) & !is.na(hb_name))
```

Plotting all statin drugs per head in each healthboard:
```{r}
grouped_cholesterol_lowering_prescriptions_plot <- grouped_cholesterol_lowering_prescriptions %>% 
ggplot(aes(x = drug_group, y = quantity_per_head, fill = drug_group)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_wrap(~hb_name) +
  labs(title = "Number of prescriptions of cholesterol lowering drugs per head in Health Boards in Scotland in 2025", x = "Drug Group", y = "Quantity per Head", fill = "Drug Group")
grouped_cholesterol_lowering_prescriptions_plot
```

It is clear that 4 drugs stand out the most in the above plot. We found that atorvastatin is the most prescribed cholesterol lowering drug in Scotland by the NHS in 2024 and 2025. It is often the first to be prescribed, and can be frequently prescribed at a low dose for preventative measures. Therefore, we go on to look at the variation of different doses of atrovastatin among health boards in Scotland.
In addition, we could explore atorvastatin, simvastatin, pravastatin, and rosuvastatin only as these are the only ones that appear in the plot.

Join health board names and jan-june 2025 data with population data 2019:
```{r}
pop_hb_joined <- grouped_cholesterol_lowering_prescriptions %>% 
  left_join(population_data, by=c("hb_name" = "hb_name", "hb_population" = "hb_population"))
```
 
 Remove unnecessary columns:
```{r}
removed_joined_final <- pop_hb_joined %>% 
  select(hbt, bnf_item_description, paid_quantity, hb_name, hb_population) %>% 
  arrange(desc(paid_quantity))
```

A)Filtering for 4 most prescribed drugs:
```{r}
four_statins <- removed_joined_final %>% 
  filter(str_detect(bnf_item_description, "ATORVASTATIN|SIMVASTATIN|PRAVASTATIN|ROSUVASTATIN")) %>% 
  mutate(quantity_per_head = paid_quantity/hb_population) %>% 
  mutate('drug_name' = case_when(str_starts(bnf_item_description, "ATORVA") ~ "ATORVASTATIN",
                               str_starts(bnf_item_description, "SIMVA") ~ "SIMVASTATIN",
                               str_starts(bnf_item_description, "PRAVA") ~ "PRAVASTATIN",
                               str_starts(bnf_item_description, "ROSUVA") ~ "ROSUVASTATIN", TRUE ~ bnf_item_description))

four_statins_plot <- four_statins %>% 
  ggplot(aes(x = hb_name, y = quantity_per_head, fill = drug_name)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Quantity per head of the four most prescribed cholesterol lowering drugs in each Health Board in July 2024 - June 2025", 
       x = "Health Board", 
       y = "Quantity per Head")
four_statins_plot

```

B)Filtering for atorvastatin - because was highest prescribed statin.
A more detailed investigation into the trends of atrovastatin prescription are meaningful to uncover the patterns of this most prescribed drug across Scotland.
Also mutating to add column including low, medium, high doses:
```{r}
atorvastatin_data <- removed_joined_final %>% 
  filter(str_detect(bnf_item_description, "ATORVASTATIN")) %>% 
  mutate(dose_category = case_when(
    bnf_item_description %in% c("ATORVASTATIN 10MG TABLETS", "ATORVASTATIN 20MG TABLETS", "ATORVASTATIN 20MG/5ML ORAL SUSPENSION SUGAR FREE") ~ "Low",
    bnf_item_description %in% c("ATORVASTATIN 30MG TABLETS", "ATORVASTATIN 40MG TABLETS") ~ "Medium",
    bnf_item_description %in% c("ATORVASTATIN 60MG TABLETS", "ATORVASTATIN 80MG TABLETS") ~ "High")) 
```

Tibble: to visualise what the different doses of atorvastatin are:
```{r}
atorvastatin_data %>% 
  distinct(bnf_item_description) %>% 
  arrange(bnf_item_description)
```

Atorvastatin per head data and plotted in chart:
This is done to make the data more representative of actual figures whereby it shows prescription per head. Misleading figures would be created if this was not done. 
```{r}
atorvastatin_per_head <- atorvastatin_data %>% 
  filter(str_detect(bnf_item_description, "ATORVASTATIN")) %>%   filter(!is.na(hb_name)) %>% 
  group_by(hb_name) %>% 
  mutate(quantity_per_head = sum(paid_quantity)/mean(hb_population))

per_head_chart <- atorvastatin_per_head %>% 
  ggplot(aes(x = quantity_per_head, y = reorder(hb_name, quantity_per_head), fill = hb_name)) +
  geom_bar(stat = "identity") +
  labs(title = "Prescription of atorvastatin per person in each health board in Scotland",
       x = "Quantity per head",
       y = "Health Board", 
       fill = "Health Board")
per_head_chart
```


Plotting atorvastatin per head data for each dose category:
```{r}

plot_data <- atorvastatin_per_head %>% 
  ggplot(aes(x = dose_category, y = quantity_per_head, fill = dose_category)) +
  geom_col() +
    facet_wrap(~hb_name) +
  labs(title = "Prescriptions of Low, Medium, and High dose Atorvastatin per head in different Health Boards in Scotland in 2025", x = "Atorvastatin Dose Category", y = "Quantity per Head", fill = "Dose Category")
plot_data
```
 
The British Heart Foundation explains correlation between deprivation in Scotland and heart disease. In Scotland, those living in the most deprived areas are almost twice as likely to die from heart and cardiovascular disease before age 75.
https://www.bhf.org.uk/what-we-do/our-research/heart-statistics/health-inequalities-research/cardiovascular-inequalities-in-scotland-an-analysis 

